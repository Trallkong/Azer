# Azer

一个用 Rust 编写的图形渲染引擎/框架，使用 Vulkan API 进行 3D 图形渲染。

## 项目概述

**Azer** 目前处于早期开发阶段（v0.1.0），实现了基础的渲染功能——在屏幕上绘制一个红色三角形。该项目基于图层架构构建，允许可扩展的游戏/图形开发。

## 核心模块

### Core 模块 (`src/core/`)

- **application.rs**: 应用主循环，管理窗口生命周期、事件分发、固定时间步长物理更新（60 Hz）、Delta 时间追踪和图层栈管理
- **layer.rs**: 可扩展"图层"系统的 trait 定义，提供以下回调：
  - `on_ready()` - 初始化
  - `on_update()` - 帧逻辑
  - `on_render()` - 渲染命令
  - `on_physics_update()` - 固定时间步长物理更新
  - `on_event()` - 事件处理
  - `on_close()` - 清理
- **layer_stack.rs**: 图层容器，支持栈式操作（push/pop/iter）
- **logger.rs**: 日志基础设施，带时间戳和级别格式化
- **delta_time.rs**: 时间增量包装器，支持秒、毫秒、微秒转换

### API 模块 (`src/api/`)

- **vulkan.rs**: Vulkan 核心集成，处理：
  - 实例、设备和队列创建
  - 物理设备选择与队列族检查
  - 交换链管理和重建
  - 渲染通道创建
  - 命令缓冲提交
  - 窗口调整大小处理
- **swapchain.rs**: Vulkan 交换链管理（FIFO 呈现模式，RGBA8 格式）
- **vulkan_helper.rs**: 辅助工具，用于：
  - 图形管线创建（顶点/片段着色器）
  - 帧缓冲创建
  - 命令缓冲创建和配置
- **shader.rs**: 内嵌 GLSL 着色器：
  - 顶点着色器：将 2D 位置转换到裁剪空间
  - 片段着色器：渲染红色 (1.0, 0.0, 0.0, 1.0)

### Render 模块 (`src/render/`)

- **renderer.rs**: 高层渲染抽象，提供：
  - 命令缓冲构建器管理
  - 带清除颜色的渲染通道设置
  - 三角形渲染委托
  - 窗口调整大小时的管线重建
- **render_triangle.rs**: 三角形渲染实现：
  - `Vertex2D` 结构（位置数据）
  - 三角形顶点缓冲创建（3 个顶点）
  - 图形管线管理
  - 绘制命令执行

## 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **Vulkano** | 0.35.2 | Vulkan 图形 API 绑定 |
| **vulkano-shaders** | 0.35.0 | 着色器编译和加载 |
| **Winit** | 0.30.12 | 窗口管理和事件处理 |
| **log** | 0.4.27 | 日志门面 |
| **env_logger** | 0.11.8 | 日志实现 |
| **chrono** | 0.4.41 | 时间戳格式化 |

## 架构特点

1. **图层系统**: 类似游戏引擎的图层架构，允许在不修改核心代码的情况下扩展功能
2. **固定时间步长**: 物理更新使用 60 Hz 固定时间步，每帧最多累积 10 步
3. **Vulkan 渲染**: 完整的 Vulkan 渲染管线，支持窗口调整大小时重建交换链
4. **事件驱动**: 基于 winit 的事件循环，处理窗口事件和输入

## 应用生命周期

1. **初始化**:
   - 日志系统初始化
   - 事件循环创建
   - 应用结构实例化
   - 图层添加到图层栈
   - 应用运行器启动

2. **恢复事件**:
   - 调用图层的 `on_ready()`
   - 创建窗口（1280x720，标题 "Azer"）
   - Vulkan 实例/设备初始化
   - 物理设备选择
   - 交换链创建
   - 渲染器初始化

3. **窗口事件处理**（每帧）:
   - 物理更新：固定 60 Hz 时间步
   - 常规更新：使用实际 Delta 时间
   - 事件分发：输入/调整大小事件发送到图层
   - 渲染：仅在 `RedrawRequested` 事件时

4. **渲染管线**:
   - 获取交换链图像
   - 开始渲染通道，清除颜色 [0.1, 0.1, 0.1, 1.0]
   - 绑定图形管线
   - 绑定顶点缓冲
   - 绘制 3 个顶点
   - 结束渲染通道
   - 提交到 GPU 队列并同步

5. **关闭**:
   - 关闭窗口触发清理
   - 调用图层的 `on_close()`
   - 清空图层栈
   - 事件循环退出

## 当前实现

- **窗口**: 1280x720，标题 "Azer"
- **物理引擎**: 固定 60 Hz 时间步，每帧最多累积 10 步
- **渲染**:
  - 清除颜色：深灰色 [0.1, 0.1, 0.1, 1.0]
  - 三角形顶点：[-0.5, 0.5], [0.5, 0.5], [0.0, -0.5]
  - 着色器输出：红色 [1.0, 0.0, 0.0, 1.0]

## 扩展性

图层系统允许添加自定义逻辑的新图层，无需修改核心引擎代码。`NewLayer` 示例展示了基本模式。

## 构建和运行

```bash
cargo build
cargo run
```

## 许可证

待定

---

这是一个结构清晰、关注点分离良好的图形引擎基础框架，为未来更复杂的渲染场景提供了扩展空间。
