# Azer

一个用 Rust 编写的 2D/3D 图形渲染引擎，使用 Vulkan API 进行高性能图形渲染。

## 项目概述

**Azer** 目前处于早期开发阶段（v0.1.0），已实现完整的 2D 渲染系统，包括相机控制、形状绘制、批量渲染和输入处理。该项目基于图层架构构建，为可扩展的游戏/图形应用开发提供了坚实基础。

## 核心特性

- ✅ **2D 相机系统**: 正交投影相机，支持位置移动和缩放
- ✅ **形状渲染**: 三角形和矩形的高效渲染
- ✅ **批量渲染**: 一次性渲染多个对象，减少 Draw Call
- ✅ **变换系统**: 支持位置、缩放、旋转的 Transform2D
- ✅ **输入处理**: 键盘（WASD）和鼠标滚轮控制
- ✅ **图层系统**: 模块化的场景管理架构
- ✅ **Vulkan 渲染**: 现代图形 API，跨平台支持
- ✅ **实例化渲染**: 支持最多100个实例的高效渲染
- ✅ **动态交换链**: 支持窗口大小调整时自动重建交换链
- ✅ **描述符集管理**: 统一的Uniform缓冲区管理

## 核心模块

### Core 模块 (`src/core/`)

- **application.rs**: 应用主循环，管理窗口生命周期、事件分发、固定时间步长物理更新（60 Hz）、Delta 时间追踪和图层栈管理
- **layer.rs**: 可扩展"图层"系统的 trait 定义，提供以下回调：
  - `on_ready()` - 初始化
  - `on_update()` - 帧逻辑
  - `on_render()` - 渲染命令
  - `on_physics_update()` - 固定时间步长物理更新
  - `on_event()` - 事件处理
  - `on_close()` - 清理
- **layer_stack.rs**: 图层容器，支持栈式操作（push/pop/iter）
- **logger.rs**: 日志基础设施，带时间戳和级别格式化
- **delta_time.rs**: 时间增量包装器，支持秒、毫秒、微秒转换

### API 模块 (`src/api/`)

- **vulkan.rs**: Vulkan 核心集成，处理：
  - 实例、设备和队列创建
  - 物理设备选择与队列族检查
  - 交换链管理和重建
  - 渲染通道创建
  - 命令缓冲提交
  - 窗口调整大小处理
  - 渲染状态管理（RenderDirty标志）
- **vulkan_helper.rs**: 辅助工具，用于：
  - Vulkan 实例和设备创建
  - 表面（Surface）和交换链（Swapchain）管理
  - 图形管线创建（顶点/片段着色器）
  - 帧缓冲创建
  - 描述符集和 Uniform 缓冲创建
  - 命令缓冲创建和配置
  - 内存分配器创建

### Renderer 模块 (`src/renderer/`)

- **renderer.rs**: 核心渲染器，管理：
  - 批量渲染系统（最多 100 个实例）
  - 着色器和图形管线管理
  - 描述符集和 Uniform 缓冲
  - 相机矩阵更新
  - 命令缓冲构建和提交
  - 2D 渲染命令接口（draw_triangle, draw_rectangle）
- **renderer2d/**: 2D 渲染实现
  - `render_triangle.rs`: 三角形渲染器
  - `render_rectangle.rs`: 矩形渲染器
- **camera/**: 相机系统
  - `camera2d.rs`: 2D 正交相机，支持视图/投影矩阵计算
  - `camera.rs`: 相机通用 trait 定义
- **shapes/**: 形状定义
  - `triangle.rs`: 三角形形状
  - `rectangle.rs`: 矩形形状
  - `transform.rs`: 2D 变换（位置、缩放、旋转）
  - `shape.rs`: 形状枚举
- **shaders/**: 着色器模块
  - `batch_render_shader.rs`: 批量渲染着色器，支持实例化渲染
  - `sd_camera2d.rs`: 2D 相机着色器数据
  - `mod.rs`: 着色器通用 trait 定义
- **vertex.rs**: 顶点数据结构定义
- **frame_commands.rs**: 帧命令缓冲管理器
- **render_trait.rs**: 渲染器通用 trait 定义

## 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **Vulkano** | 0.35.2 | Vulkan 图形 API 绑定 |
| **vulkano-shaders** | 0.35.0 | 着色器编译和加载 |
| **Winit** | 0.30.12 | 窗口管理和事件处理 |
| **glam** | 0.30.9 | 高性能数学库（向量、矩阵、四元数） |
| **log** | 0.4.27 | 日志门面 |
| **env_logger** | 0.11.8 | 日志实现 |
| **chrono** | 0.4.41 | 时间戳格式化 |
| **bitflags** | 2.10.0 | 位标志工具 |

## 架构特点

1. **图层系统**: 类似游戏引擎的图层架构，允许在不修改核心代码的情况下扩展功能
2. **固定时间步长**: 物理更新使用 60 Hz 固定时间步，每帧最多累积 10 步
3. **批量渲染**: 使用实例化渲染技术，单次 Draw Call 渲染多个对象（当前支持最多 100 个实例）
4. **2D 相机系统**: 完整的相机系统，支持视图矩阵和投影矩阵变换
5. **变换系统**: 基于组件的变换系统，支持位置、缩放、旋转
6. **Vulkan 渲染**: 完整的 Vulkan 渲染管线，支持窗口调整大小时重建交换链
7. **事件驱动**: 基于 winit 的事件循环，处理窗口事件和输入
8. **数学库集成**: 使用 glam 进行高性能的向量和矩阵运算
9. **内存管理**: 使用Vulkano的标准内存分配器进行高效资源管理
10. **描述符系统**: 统一的描述符集管理，支持相机和实例数据的高效传输

## 应用生命周期

1. **初始化**:
   - 日志系统初始化
   - 事件循环创建
   - 应用结构实例化
   - 图层添加到图层栈
   - 应用运行器启动

2. **恢复事件**:
   - 调用图层的 `on_ready()`
   - 创建窗口（1280x720，标题 "Azer"）
   - Vulkan 实例/设备初始化
   - 物理设备选择
   - 交换链创建
   - 渲染器初始化

3. **窗口事件处理**（每帧）:
   - 物理更新：固定 60 Hz 时间步
   - 常规更新：使用实际 Delta 时间
   - 事件分发：输入/调整大小事件发送到图层
   - 渲染：仅在 `RedrawRequested` 事件时

4. **渲染管线**:
   - 获取交换链图像
   - 开始渲染通道，清除颜色 [0.1, 0.1, 0.1, 1.0]
   - 绑定图形管线
   - 绑定顶点缓冲
   - 绘制顶点（支持索引缓冲）
   - 结束渲染通道
   - 提交到 GPU 队列并同步

5. **关闭**:
   - 关闭窗口触发清理
   - 调用图层的 `on_close()`
   - 清空图层栈
   - 事件循环退出

## 当前实现

### 窗口与渲染
- **窗口**: 1280x720，标题 "Azer"
- **清除颜色**: 深灰色 [0.1, 0.1, 0.1, 1.0]
- **渲染能力**:
  - 三角形渲染
  - 矩形渲染
  - 批量渲染（最多 100 个对象）
  - 实例化渲染
  - 索引缓冲支持

### 相机系统
- **类型**: 2D 正交相机
- **默认配置**:
  - 宽高比: 16:9
  - 缩放: 1.0
  - 位置: (0.0, 0.0)
  - 近平面: -1.0
  - 远平面: 1.0
- **功能**: 实时视图/投影矩阵更新

### 变换系统
- **Transform2D**:
  - 位置 (Vec2)
  - 缩放 (Vec2)
  - 旋转 (Quat)

### 输入控制
- **键盘控制**:
  - W/A/S/D: 相机移动（上/左/下/右）
  - 移动速度: 0.2 单位/按键
- **鼠标控制**:
  - 滚轮: 相机缩放
  - 缩放速度: 0.1 单位/滚动

### 示例场景（NewLayer）
- 渲染 5x5 棋盘格图案（矩形）
- 展示批量渲染能力
- 相机控制演示
- 动态旋转效果

## 扩展性

图层系统允许添加自定义逻辑的新图层，无需修改核心引擎代码。每个图层可以：

- **on_ready()**: 初始化资源和状态
- **on_update()**: 每帧更新逻辑（接收 DeltaTime）
- **on_render()**: 渲染调用（使用 Renderer API）
- **on_physics_update()**: 固定时间步物理更新
- **on_event()**: 处理窗口和输入事件
- **on_close()**: 清理资源

### 使用示例

```rust
use azer::core::layer::Layer;
use azer::renderer::renderer::Renderer;
use azer::renderer::shapes::transform::Transform2D;
use glam::{Vec2, Quat};

pub struct MyLayer;

impl Layer for MyLayer {
    fn on_render(&mut self, renderer: &mut Renderer) {
        let transform = Transform2D {
            position: Vec2::new(0.0, 0.0),
            scale: Vec2::new(1.0, 1.0),
            rotation: Quat::IDENTITY,
        };
        renderer.draw_rectangle(transform, [1.0, 0.0, 0.0, 1.0]);
    }
}
```

## 构建和运行

```bash
cargo build
cargo run
```

---

Azer 是一个结构清晰、关注点分离良好的 2D/3D 图形引擎框架，已实现完整的 2D 渲染系统。通过批量渲染、相机系统和模块化的图层架构，为构建复杂的图形应用和游戏提供了坚实基础。项目采用现代Vulkan API，确保高性能和跨平台兼容性。

## 路线图

未来计划实现的功能：
- 🔲 纹理系统和精灵渲染
- 🔲 文本渲染
- 🔲 粒子系统
- 🔲 3D 渲染支持
- 🔲 物理引擎集成
- 🔲 场景管理系统
- 🔲 资源管理器